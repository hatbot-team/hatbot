<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="hatbot-data-service.html">
<link rel="import" href="hatbot-play.html">
<link rel="import" href="hatbot-rate.html">
<link rel="import" href="bower_components/core-scaffold/core-scaffold.html">
<link rel="import" href="bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="bower_components/core-menu/core-menu.html">
<link rel="import" href="bower_components/core-menu/core-submenu.html">
<link rel="import" href="bower_components/core-item/core-item.html">
<link rel="import" href="bower_components/core-tooltip/core-tooltip.html">
<link rel="import" href="bower_components/paper-dialog/paper-action-dialog.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">

<polymer-element name="hatbot-app">
    <template>
        <hatbot-data-service
                id="loader"
                word="{{word}}"
                explanations="{{explanations}}"
                on-got-word="{{updateExplanations}}"
                on-no-explanations="{{noExplanationsHandler}}"
                on-got-explanations="{{gotExplanationsHandler}}">
        </hatbot-data-service>

        <core-scaffold mode="waterfall">
            <nav>
                <h1 style="text-align: center">Шляпобот</h1>
                <core-menu theme="core-light-theme">
                    <core-submenu label="Играть с ботом">
                        <core-item
                                on-click="{{playRandom}}"
                                label="играть случайное слово">
                        </core-item>
                        <core-item
                                label="играть своё слово"
                                on-click="{{toggleDialog}}">
                            <paper-action-dialog backdrop>
                                <paper-input
                                        label="слово для игры"
                                        value="{{given}}"
                                        floatingLabel>
                                </paper-input>
                                <paper-button
                                        affirmative
                                        on-click="{{playOwn}}">
                                    Играть
                                </paper-button>
                            </paper-action-dialog>
                        </core-item>
                    </core-submenu>
                    <core-submenu label="Оценивать и править">
                        <core-item
                                label="случайные объяснения"
                                on-click="{{rateRandom}}">
                        </core-item>
                        <core-item
                                label="объяснения своего слова"
                                on-click="{{toggleDialog}}">
                            <paper-action-dialog backdrop>
                                <paper-input
                                        label="слово для оценки"
                                        value="{{given}}"
                                        floatingLabel>
                                </paper-input>
                                <paper-button
                                        affirmative
                                        on-click="{{rateOwn}}">
                                    Оценивать
                                </paper-button>
                            </paper-action-dialog>
                        </core-item>
                    </core-submenu>
                </core-menu>
            </nav>

            <div tool>{{titles[state]}}</div>

            <div>
                <hatbot-play
                        id="play"
                        hidden?="{{state != 'play'}}"
                        word="{{word}}"
                        mind="{{explanations}}"
                        said="{{said}}">
                </hatbot-play>
                <hatbot-rate
                        id="rate"
                        hidden?="{{state != 'rate'}}"
                        word="{{word}}"
                        mind="{{explanations}}"
                        said="{{said}}"
                        canExplain="{{canExplain}}">
                </hatbot-rate>
            </div>
        </core-scaffold>
    </template>
    <script>
        Polymer({
            ready: function() {
                this.explanations = [];
                this.said = [];
                this.canExplain = true;
                this.given = '';
                this.titles = {'play': 'Игра с ботом', 'rate': 'Оценка объяснений'};
                this.state = 'play';
                this.$.play.greet();
                this.updateWord();
            },
            clear: function() {
                this.explanations = [];
                this.said = [];
            },
            playRandom: function() {
                this.clear();
                this.$.play.clear();
                this.state = 'play';
                this.updateWord();
            },
            playOwn: function() {
                this.clear();
                this.$.play.clear();
                this.state = 'play';
                this.word = this.given;
                this.updateExplanations();
            },
            rateRandom: function() {
                this.clear();
                this.$.rate.clear();
                this.state = 'rate';
                this.updateWord();
            },
            rateOwn: function() {
                this.clear();
                this.$.rate.clear();
                this.state = 'rate';
                this.word = this.given;
                this.updateExplanations();
            },
            updateWord: function() {
                var loader = this.$.loader;
                loader.loadRandomWord();
            },
            updateExplanations: function() {
                var loader = this.$.loader;
                loader.loadExplanations();
            },
            noExplanationsHandler: function() {
                this.canExplain = false;
                this.state = 'rate';
                console.log("no Explanations");
            },
            gotExplanationsHandler: function() {
                this.canExplain = true;
                if (this.state == 'play'){
                    this.$.play.startExplain();
                } else if (this.state == 'rate') {
                    this.$.rate.startExplain();
                }
            },
            toggleDialog: function(e) {
                var d = e.target.querySelector('paper-dialog,paper-action-dialog');
                d.toggle();
            }
        });
    </script>
</polymer-element>
